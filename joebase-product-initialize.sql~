
-- Create a master view of the data to be processed
CREATE OR ALTER VIEW temp_action_figure_data_master AS
	SELECT temp_action_figures_v2.id								temp_af_id,
		temp_action_figures_v2.product								product_name, 
		temp_action_figures_v2.Keywords								product_description, 
		temp_action_figures_v2.[Year of Release]					year_of_release,
		temp_action_figures_v2.[Purchase Price]						purchase_price,
		dbo.getRetailerID(temp_action_figures_v2.[Purchased From])	purchased_from_retailer_id,
		temp_action_figures_v2.[Purchased From]						purchased_from_retailer_name,
		dbo.getRetailerID(temp_action_figures_v2.[Exclusive To])	exclusive_to_retailer_id,
		temp_action_figures_v2.[Exclusive To]						exclusive_to_retailer_name,
		dbo.getManufacturerID(temp_action_figures_v2.Producer)		manufacturer_id,
		temp_action_figures_v2.Producer								manufacturer_name,
		temp_action_figures_v2.[# Figs]								number_of_figures
	FROM temp_action_figures_v2;
GO

----------------------------------------------------------------------------------------------------
-- VARIABLE DECLARATIONS

-- Determine and save the product type to be used for all action figure products being inserted.
DECLARE @action_figure_product_type_id INT = dbo.getProductTypeID('1:6 figure');

-- Temporary variables
DECLARE @id								INT;
DECLARE @product_name					NVARCHAR(128);
DECLARE @product_description			NVARCHAR(1024);
DECLARE @year_of_release				INT;
DECLARE @purchase_price					DECIMAL(19,4);
DECLARE @purchased_from_retailer_id		INT;
DECLARE @purchased_from_retailer_name	NVARCHAR(128);
DECLARE @exclusive_to_retailer_id		INT;
DECLARE @exclusive_to_retailer_name		NVARCHAR(128);
DECLARE @manufacturer_id				INT;
DECLARE @manufacturer_name				NVARCHAR(128);
DECLARE @number_of_figures				INT;

----------------------------------------------------------------------------------------------------
DECLARE csr_TempActionFigure CURSOR FOR
	SELECT temp_af_id, product_name,  product_description,  year_of_release, purchase_price,
		purchased_from_retailer_id, purchased_from_retailer_name,
		exclusive_to_retailer_id, exclusive_to_retailer_name, 
		manufacturer_id, manufacturer_name, number_of_figures
	FROM temp_action_figure_data_master;

-- Everything is declared, let's clear out the tables being inserted into
DELETE action_figure;
DELETE product;


-- Loop through the lines items in the temporary imported Excel table
OPEN csr_TempActionFigure;
FETCH NEXT
FROM csr_TempActionFigure
INTO @id, @product_name, @product_description, @year_of_release, @purchase_price,
	@purchased_from_retailer_id, @purchased_from_retailer_name, 
	@exclusive_to_retailer_id, @exclusive_to_retailer_name, 
	@manufacturer_id, @manufacturer_name, @number_of_figures;

WHILE @@FETCH_STATUS = 0
BEGIN
	EXECUTE dbo.insertProductRecord @product_name, action_figure_product_type_id, @product_description,
		@year_of_release, @purchase_price, @purchased_from_retailer_id, @exclusive_to_retailer_id,
		@manufacturer_id;

	FETCH NEXT
	FROM csr_TempActionFigure
	INTO @id, @product_name, @product_description, @year_of_release, @purchase_price,
		@purchased_from_retailer_id, @purchased_from_retailer_name, 
		@exclusive_to_retailer_id, @exclusive_to_retailer_name,
		@manufacturer_id, @manufacturer_name, @number_of_figures;

END; -- While Fetch

CLOSE csr_TempActionFigure;
DEALLOCATE csr_TempActionFigure;